---
- name: Assert that the required vars exist and are matching the expected content
  ansible.builtin.assert:
    that:
      - tools_dnsmasq_domains is defined
      - tools_dnsmasq_ips is defined
      - tools_dnsmasq_domains|length == tools_dnsmasq_ips|length

- name: Stop dnsmasq if running
  become: yes
  ansible.builtin.shell: "set -o pipefail && pkill dnsmasq || true"
  changed_when: true

- name: Ensure dnsmasq is installed
  become: true
  ansible.builtin.package:
    name: dnsmasq
    state: present

- name: Create /etc/dnsmasq.conf
  become: yes
  ansible.builtin.template:
    src: dnsmasq.j2
    dest: /etc/dnsmasq.conf
    mode: u=rw,g=r,o=r

- name: Backup the /etc/resolv.conf file
  become: true
  ansible.builtin.copy:
    remote_src: yes
    src: /etc/resolv.conf
    dest: /etc/resolv.conf.orig
    mode: u=rw,g=r,o=r
    force: no

- name: Start dnsmasq in the background
  become: yes
  ansible.builtin.command: "/usr/sbin/dnsmasq"
  changed_when: true

- name: Verify dnsmasq is running
  become: yes
  ansible.builtin.command: "pgrep dnsmasq"
  changed_when: false

# /etc/resolv.conf is protected inside the pod
# and the only way to edit it is by redirection.
- name: Update nameserver in /etc/resolv.conf to localhost
  become: true
  ansible.builtin.command:
    cmd: "echo 'nameserver 127.0.0.1' > /etc/resolv.conf"
  changed_when: true

- name: Test DNS resolution with dig
  ansible.builtin.command:
    cmd: dig +short {{ tools_dnsmasq_domains[0] }}
  register: dig_result
  changed_when: false

- name: Verify the resolved IP
  ansible.builtin.assert:
    that:
      - dig_result.stdout.strip() == tools_dnsmasq_ips[0]
    fail_msg: |
      {{ tools_dnsmasq_domains[0] }} DNS resolution did not
      return the expected IP {{ tools_dnsmasq_ips[0] }}
    success_msg: |
      {{ tools_dnsmasq_domains[0] }} DNS resolution returned
      the expected IP {{ tools_dnsmasq_ips[0] }}
