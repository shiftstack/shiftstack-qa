---
- name: TBD
  hosts: localhost
  gather_facts: yes
  vars_files:
    - "../configs/global.yml"
  tasks:

    - name: Discover OCP version and networkType
      ansible.builtin.include_role:
        name: shiftstack.tools.tools_get_deploy_info
        tasks_from: discover_ocp_version.yml

    - name: Set TP flag if needed
      when: discovered_openshift_release is version('4.19', '<=')
      block:
        - name: Ensure project local-cluster exists
          ansible.builtin.include_role:
            name: tools_ocp_project
            tasks_from: recreate_ocp_project.yml
          vars:
            project_name: local-cluster
            force_delete: false

        - name: Set tech-preview-no-upgrade flag for hypershift operator
          kubernetes.core.k8s:
            state: present
            kubeconfig: "{{ kubeconfig }}"
            definition:
              apiVersion: config.openshift.io/v1
              kind: ConfigMap
              metadata:
                name: version
                namespace: local-cluster
              data:
                installFlagsToAdd: "--tech-preview-no-upgrade"
                installFlagsToRemove: ""

    - name: Install multicluster-engine operator and deploy the default MultiClusterEngine
      vars:
        install_openshift_operator_namespace: multicluster-engine
        install_openshift_operator_catalogsource: redhat-operators
        install_openshift_operator_package: multicluster-engine
        install_openshift_operator_name: multicluster-engine
        install_openshift_operator_provided_api: MultiClusterEngine
        single_namespace_installation: true
      ansible.builtin.include_role:
        name: shiftstack.tools.tools_install_openshift_operator

    - name: Download and install hcp binary locally #no-qa: command-instead-of-module
      ansible.builtin.shell: |
        set -o pipefail
        wget --no-check-certificate \
          $(oc get ConsoleCLIDownload hcp-cli-download -o json | jq -r '.spec.links[] | \
            select(.text == "Download hcp CLI for Linux for x86_64") | .href')
        tar xvzf hcp.tar.gz
        chmod +x hcp
        sudo mv hcp /usr/local/bin/.
      changed_when: true

    - name: Insert in .bashrc hypershift completion
      ansible.builtin.lineinfile:
        dest: "{{ home_dir }}/.bashrc"
        line: "source <(hcp completion bash)"
